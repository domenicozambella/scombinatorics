% !TEX root = scombinatorics.tex
\documentclass[scombinatorics.tex]{subfiles}
\begin{document}
\chapter{Stability}
\label{sauer}



\def\medrel#1{\parbox[t]{5ex}{$\displaystyle\hfil #1$}}
\def\ceq#1#2#3{\parbox[t]{20ex}{$\displaystyle #1$}\medrel{#2}{$\displaystyle #3$}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The order property}\label{ladder}

The \emph{chain index\/} of $\phi(\U\,;b)_{b\in\V}$, or of $\phi(x\,;z)$ when $\U$ and $\V$ are clear, is the maximal length (that is, $n+1$) of a chain of the form

\ceq{\ssf{ch}\hfill\phi(A\,;b_0)\ \subset}{\dots}{\subset\ \phi(A\,;b_n)}

for some set $A\subseteq\U$ and some $b_0,\dots,b_n\in\V$.
Note that we allow $\phi(A\,;b_0)$ to be empty.
This choice produces a small asymmetry below in the definition of ladder; see also Fact~\ref{fact_stability_dual}.

\begin{example}
  If $\phi(\U\,;b)_{b\in\V}$ consists of just one set, the chain index is $1$.
  If it contains two distinct sets, the  chain index is at least $2$ and it is exactly $2$ if there are no more two sets, or if all sets are disjoint.\QED
\end{example}

If a maximal length does not exist, we say that $\phi(x\,;z)$ is \emph{unstable,} or that it has the \emph{order-property.} 
Otherwise we say that it is \emph{stable.}

In place of requiring the existence of the chain in \ssf{ch}, we could equivalently ask for a pair of tuples $a_1,\dots,a_n\in\U$ and $b_0,\dots,b_n\in\V$ such that

\ceq{\ssf{ld}\hfill\phi(a_h\,;b_k)}
{\IFF}
{h\le k.}

We call this pair of tuples a \emph{ladder\/} of length $n+1$.
We may also say \emph{ladder index\/} instead of chain index.
Setting $A=\{a_1,\dots,a_n\}$ we easily obtain a chain from a ladder, the converse is left as an easy exercise for the reader.

\begin{exercise}
  Let $\phi(x\,;z)$ have chain index $n+1$ or more. 
  Let $A\subseteq\U$ be a minimal set such that a chain as in \ssf{ch} obtains for some $b_0,\dots,b_n\in\V$.
  Prove that there is a ladder $a_1,\dots,a_n$ and $b_0,\dots,b_n$ such that $A=\{a_1,\dots,a_n\}$ and conclude that $\phi(x\,;z)$ has ladder index $n+1$.\QED
\end{exercise}

The following facts are obvious but worth noting.

\begin{fact}\label{fact_stability_dual}
  Let $\phi(x\,;z)$ have ladder index $n+1$. 
  Then $\phi(x\,;z)^{\rm op}$ has ladder index $\ge n$.\QED
\end{fact}
 
\begin{fact}\label{fact_stability_neg}
  Let $\phi(x\,;z)$ have ladder index $n$. 
  Then $\neg\phi(x\,;z)$ has ladder index $n$.\QED
\end{fact}

\begin{proof}
  If for all $h\in(n]$ and $k\in[n]$ 

  \ceq{\hfill\neg\phi(a_h\,;b_k)}
  {\IFF}
  {h\le k}

  then $a'_h=a_{n+1-h}$ and $b'_k=b_{n-k}$ satisfy

  \ceq{\hfill\phi(a'_h\,;b'_k)}
  {\IFF}
  {\phi(a_{n+1-h}\,;b_{n-h})}

  \ceq{}
  {\IFF}
  {n-k>n+1-h}

  \ceq{}
  {\IFF}
  {h\le k}
\end{proof}
 
The following definition is connected with those above, though in a less evident manner.
We write ${}^n2$ for the set of binary sequences of length $n$ or, more precisely, the set of functions $s:[n)\to[2)$.
We write $s_h$ for the value of $s$ at $h$, and $s{\restriction} h$ for the restriction of $s$ to $[h)$.
We define ${}^{<n}2=\big\{r\, :\, r\in {}^h2,\ h\in[n)\big\}$.

A \emph{branching tree\/} of height $n$ for the formula $\phi(x\,;z)$ is a function 

\ceq{\hfill\bar{a}\ :\ {}^{<n}2}{\to}{\U}
\nopagebreak[4]\par
\ceq{\hfill r}{\mapsto}{a_r},

which we may also present by writing $\bar a=\<a_r:r\in{}^{<n}2\>$, such that

\ceq{\ssf{2r}\hfill\0}
{\neq}
{\bigcap_{h=0}^{n-1}\neg^{s_h}\,\phi(a_{s\restriction h}\,;\V)}\hfill for all $s\in {}^n2$.

where $\neg^i$, for $i$ a non negative integer, denotes a negation symbol repeated $i$ times.
In other words \ssf{2r} requires the existence of some $\<b_s:s\in{}^n2\>$ such that

\ceq{\hfill\phi(a_{s\restriction h}\,;b_s)}
{\IFF}
{s_h=0}\hfill for all pairs $s\in {}^n2$ and $h\in[n)$

or, with slightly different notation,

\ceq{\hfill\phi(a_r\,;b_s)}
{\IFF}
{r^\frown0\subseteq s}\hfill for all pairs $r\subset s\in {}^n2$.

It helps to represent a branching tree as follows.
For definiteness, fix $n=3$.
Consider a full binary tree of height $n+1$ and assign to each internal node (different from root and leaves) a formula as depicted below.
Then \ssf{2r} requires that all formulas in each branch $s\in2^n$ are satified by some $b_s\in\V$.
\medskip

% Set the overall layout of the tree
\tikzstyle{level 1}=[level distance=3.5cm, sibling distance=2.5cm]
\tikzstyle{level 2}=[level distance=3.5cm, sibling distance=1.2cm]
\tikzstyle{level 3}=[level distance=2.5cm, sibling distance=0.5cm]
\tikzstyle{level 4}=[level distance=0.5cm, sibling distance=0.5cm]

% Define styles for bags and leafs
\tikzstyle{bag0} = [text width=2.5ex, align=left]
\tikzstyle{bag} = [text width=7.5ex, align=right]
%\tikzstyle{end} = [circle, minimum width=3pt,fill, inner sep=0pt]

\begin{tikzpicture}[grow=right]
\node[bag0] {{$\top$}}
    child {
        node[bag] {$\phi(a_{\0};z)$}      
            child {
                node[bag] {$\phi(a_1;z)$}
                    child {
                       node[bag] {\footnotesize$\phi(a_{11};z)$\rlap{ ----- $b_{111}$}}
                       edge from parent
                    }    
                    child {
                       node[bag] {\footnotesize$\llap{$\neg$}\phi(a_{11};z)$\rlap{ ----- $b_{110}$}}
                       edge from parent
                    }  
                 edge from parent
            }
            child {
                node[bag] {\llap{$\neg$}$\phi(a_1;z)$}
                edge from parent
                    child {
                       node[bag] {\footnotesize$\phi(a_{10};z)$\rlap{ ----- $b_{101}$}}
                       edge from parent
                    }    
                    child {
                       node[bag] {\footnotesize\llap{$\neg$}$\phi(a_{10};z)$\rlap{ ----- $b_{100}$}}
                       edge from parent
                    }  
                 edge from parent
            }
       edge from parent 
    }
    child {
        node[bag] {\llap{$\neg$}$\phi(a_{\0};z)$}         
            child {
                node[bag] {$\phi(a_0;z)$}
                    child {
                       node[bag] {\footnotesize$\phi(a_{01};z)$\rlap{ ----- $b_{011}$}}
                       edge from parent
                    }    
                    child {
                       node[bag] {\footnotesize\llap{$\neg$}$\phi(a_{01};z)$\rlap{ ----- $b_{010}$}}
                       edge from parent
                    }  
                 edge from parent
            }
            child {
                node[bag] {\llap{$\neg$}$\phi(a_0;z)$}
                edge from parent
                    child {
                       node[bag] {\footnotesize$\phi(a_{00};z)$\rlap{ ----- $b_{001}$}}
                       edge from parent
                    }    
                    child {
                       node[bag] {\footnotesize\llap{$\neg$}$\phi(a_{00};z)$\rlap{ ----- $b_{000}$}}
                       edge from parent
                    }  
                 edge from parent
            } 
        edge from parent
    };
\end{tikzpicture}
\smallskip

The Shelah \emph{2-rank\/} of $\phi(x\,;z)$ is the maximal height of a branching tree for $\phi(x\,;z)$.
If such a maximal integer does not exist, we say that the 2-rank is infinite.

\begin{example}
  If $\phi(\U\,;b)_{b\in\V}$ consists of just one set, the only branching tree for $\phi(x\,;z)$ is the empty tree.
  Therefore the 2-rank is $0$.
  If there are at least two distinct definable sets, then we can always find $a_\0, b_0,b_1$ such that $\phi(a_\0,b_0)\niff\phi(a_\0,b_1)$ hence the 2-rank is at least $1$.\QED  
\end{example}

A branching tree $\bar a'=\<a'_r:r\in{}^{<m}2\>$ is a \emph{subtree\/} of $\bar a$ if there is an $\subseteq$-preserving map $f:{}^{<m}2\to{}^{<n}2$ such that $a'_r=a_{fr}$.

The theorem below needs the following Ramsey-like lemma.

% \begin{lemma}\label{lem_Ramsey_on_trees}
%   Let $\bar a=\<a_r\, :\, r\in{}^{<2m}2\>$ be a branching tree for $\phi(x\,;z)$.
%   Let $k\in[2m]$ be given.
%   Then, for every $2$-coloring of $\range(\bar a)$, there is a branching tree $\bar a'=\<a'_r\, :\, r\in{}^m2\>$ such that  $\range(\bar a')$ is a monochromatic subset of $\range(\bar a)$.\QED
% \end{lemma}

% As it happens, a more general lemma is easier to prove.

\begin{lemma}\label{lem_Reamsey_tree}
  Let $\bar a=\<a_r\, :\, r\in{}^{<n}2\>$ be a branching tree for $\phi(x\,;z)$.
  Let $k\in[n]$ be given.
  Then, for every red-blue coloring of $\range(\bar a)$,  there is a monochromatic branching subtree, say $\bar a'=\<a'_r\, :\, r\in{}^{n'}2\>$, and either all nodes of $\bar a'$ are red and $n'=k$, or they are all blue and $n'=n-k$.
\end{lemma}

\begin{proof}
  Induction on $n$.
  First, note that the lemma is trivial when $k=0$ or $k=n$.
  In particular the lemma holds for $n=1$.

  Assume the lemma true for $n$ and prove it for $n+1$.
  Let  $\bar a=\<a_r\, :\, r\in{}^{n+1}2\>$ be given.
  Fix some $k\in[n+1]$. 
  We want a branching tree $\bar a'$ that is either red of height $k$ or blue of height $n+1-k$.
  
  If we discard the trivial cases, we can assume $k\in(n]$.

  For $i=0,1$ we define $\bar a_i=\<a_{i^\frown r}\;:\;r\in {}^{<n}2\>$.

  First suppose that $a_\0$ is blue.
  If, for either $i=0$ or $i=1$, there is a red branching tree $\bar a'_i$ of height $k$, we are done.
  Otherwise, for both $i=0,1$ there is a blue branching tree $\bar a'_i$ of height $n-k$.
  Then we graft these two trees on $a_\0$, which is also blue, and obtain the required blue tree of height $n-k+1$.
  
  Now suppose that $a_\0$ is red.
  If, for either $i=0$ or $i=1$, there is a blue branching tree $\bar a'_i\subseteq \bar a_i$ of height $n-(k-1)$, we are done.
  Otherwise, we graft on $a_\0$ two red trees of height $k-1$ to obtain a red tree of height $k$.  
\end{proof}

We are now ready to characterize stability via the 2-rank.
The proof is based on Hodges~\cite{hodges}.
It is a direct proof which yields an explicit bound on the 2-rank given the ladder index (it yields also the converse, but this is easy).
This bound may be far from optimal.

Shelah was the first to prove the equivalence \ssf{1}$\IFF$\ssf{2} below.
His proof is model theoretic and does not gives explicit bounds.
However it introduces some deep insight on sable formulas that we will present in the next section.

\begin{theorem}\label{thm_hodges}
  The following are equivalent
  \begin{itemize}
    \item[1.] $\phi(x\,;z)$ is stable;
    \item[2.] $\phi(x\,;z)$ has finite 2-rank.
  \end{itemize}
  Precisely, if $n_{\rm ld}$ and $n_{\rm 2r}$ are the ladder index and the 2-rank, respectively, then 
  
  \ceq{\hfill n_{\rm ld}}{<}{2^{n_{\rm 2r}+1};}

  \ceq{\hfill n_{\rm 2r}}{<}{2^{n_{\rm ld}+1}-2.}
\end{theorem}

\begin{proof}[Proof (\kern.1ex\ssf{2}\kern.3ex\boldmath$\IMP$\ssf{1})]
  % \def\ceq#1#2#3{\parbox[t]{29ex}{$\displaystyle #1$}\medrel{#2}{$\displaystyle #3$}}
  % \ssf{1}$\IMP$\ssf{2} 
  % We prove the contrapositive.
  % If there is a binary tree of height $n$ then there is a ladder of length $n$.
  % This also proves the first inequality of the proposition.

  % Let $\{a_s\; :\; s\in2^{<n}\}$ and $\{b_s\; :\; s\in2^{n}\}$ satisfy \ssf{2r}.
  % Apply \ssf{2r} to sequences of the form $1^k\,0^{n-k}$ for $0\le k\le n$.

  % % Define $a'_1,\dots,a'_n$ and $b'_0,\dots,b'_n$, where $a'_h=a_{1^{h-1}}$ and $b'_k=b_{1^k0^{n-k}}$.
  % % By \ssf{2r} we have

  % \ceq{\hfill\phi(a_{1^k\,0^{n-k}\,\restriction\, h-1}\;;\,b_{1^k\,0^{n-k}})}
  % {\IFF}
  % {\big(1^k0^{n-k}\big)_{h-1}=1}

  % \ceq{}
  % {\IFF}
  % {h\le k}

  
  We prove the contrapositive.
  We show that if there is a ladder of length $m=2^n$, say $a_1,\dots,a_{m-1}$ and $b_0,\dots,b_{m-1}$, then there is a branching tree $\bar a'$ of height $n$.
  This also proves the first inequality above.
  In fact, if $n_{\rm ld}\ge 2^{n_{\rm 2r}+1}$, there would exist a branching tree of height $n_{\rm 2r}+1$ which is a contradiction.
  
  The branching tree $\bar a'=\<a'_r\, :\, r\in{}^{<n}2\>$ is defined as follows

  \quad $a'_r=a_h$\quad  where $h$ is obtained reading $r^\frown1^\frown0^{n-|r|-1}$ as an $n$-digit binary number.

  To verify \ssf{2r} we define for $s\in{}^n2$ 
  
  \quad $b'_s=b_k$\quad  where $k$ is obtained reading $s$ as an $n$-digit binary number.

  Then it is easy to verify that for all pairs $r\subset s\in{}^n2$

  \ceq{\hfill\phi(a'_r\,;b'_s)}
  {\IFF}
  {\phi(a_h\,;b_k)}\hfill where $h$ and $k$ are like above

  \ceq{}
  {\IFF}
  {h\le k}

  \ceq{}
  {\IFF}
  {r^\frown1^\frown0^{n-|r|-1}\ \le\ s}\hfill  as $n$-digit binary numbers

  \ceq{}
  {\IFF}
  {r^\frown1\ \subseteq\ s}

  \textbf{(\ssf{1}\kern.2ex\boldmath$\IMP$\ssf{2}\kern.1ex)}\ 
  We prove the contrapositive.
  We claim that if there is a branching tree $\bar a$ of height $2^n-2$ then there is a ladder $a_1,\dots,a_{n-1}$ and $b_0,\dots,b_{n-1}$, of length $n$, such that $a_1,\dots,a_{n-1} \in \range(\bar a)$ and $b_0,\dots,b_{n-1} \in \{b_s:s\in{}^{2^n-2}2\}$.
  This yields also the second inequality of the theorem.
  In fact, if $n_{\rm 2r}\ge 2^{n_{\rm ld}+1}-2$, there would exist a ladder of length $n_{\rm ld}+1$ which is a contradiction.

  As $n_{\rm ld}\ge 1$, we start the induction from $n=2$.
  In this case the claim is witnessed by ladder $a_\0$ and $b_0,b_1$.
  Now we assume the claim is true for $n$ and prove it for $n+1$.

  Let $\<a_r\, :\, r\in{}^{<\, 2m+2}2\>$, where $m=2^n-2$, be a branching tree of height $2^{n+1}-2$.
  To each $b\in\{b_s:s\in{}^{2m+2 }2\}$ we associate a red-blue coloring of $\range(\bar a)$ as follows.
  A node $a\in\range(\bar a)$ is colored
  
  \qquad\qquad \llap{red}\qquad if $\phi(a\,;b)$ holds;
  
  \qquad\qquad \llap{blue}\qquad otherwise, that is, $\neg\phi(a\,;b)$.
  
  We consider two cases that are exhaustive by Lemma~\ref{lem_Reamsey_tree}.
  Note that we are applying the lemma only to the subtree $\<a_{1^\frown r}:r\in{}^{2m+1}2\>$.

  Case 1: for some $b$ there is a red subtree of $\<a_{1^\frown r}:r\in{}^{2m+1}2\>$ of height $m+1$.
  Let $\bar a'$ be this red tree and consider its subtree $\<a'_{0^\frown r}\,:\,r\in {}^{<\,m}2\>$.
  By induction hypothesis, there are $A\subseteq\{a'_{0^\frown r}\,:\,r\in {}^{<\,m}2\}$ and $b_0,\dots,b_{n-1}$ such that

  \ceq{(1)\hfill\phi(A\,;b_0)\ \subset}{\dots}{\subset\ \phi(A\,;b_{n-1})}

  Let $A'=A\cup\{a'_\0\}$ then

  \ceq{(2)\hfill\phi(A'\,;b_0)\ \subset}{\dots}{\subset\ \phi(A'\,;b_{n-1})}

  In fact, as $b_0,\dots,b_{n-1}\in\neg\phi(a'_\0\,;\V)$, this is the same chain as (1).
  Therefore, if we extend the chain on the right with $\phi(A'\,;b)=A'$, we obtain the required chain of length $n+1$.
  
  Case 2: for every $b$ there is a blue subtree of $\<a_{1^\frown r}:r\in{}^{2m+1}2\>$ of height $m$.
  Pick any $b\in\{b_s:s\in{}^{2m+2}2\}$ such that $\neg\phi(a_\0, b)$ and let $\bar a'$ the corresponding blue subtree.
  Apply the induction hypothesis to obtain $A\subseteq\range(\bar a')$ and $b_0,\dots,b_{n-1}$ such that (1).
  We claim that (2) above holds with $A'=A\cup\{a_\0\}$.
  In fact, $b_0,\dots,b_{n-1}\in\phi(a_\0\,;\V)$ so (2) is the chain in (1) with all sets augmented by $a_\0$.
  We can extend the chain on the left with $\phi(A'\,;b)=\0$ and obtain the required chain of length $n+1$.
\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Approximable sets}

The notion of approximable set is a combinatorial counterpart of the model theoretical notion of externally definable set.

\begin{definition}\label{def_approx}
  We say that $\Aa\subseteq\U$ is \emph{approximable\/} if for every finite set $A\subseteq\U$ there is a $b\in\V$ such that $\phi(A\,;b)=\Aa\cap A$.
  If we also have that $\phi(\U\,;b)\subseteq\Aa$, then we say that $\Aa$ is approximable \emph{from below.}\QED
\end{definition}

The following is immediate.

\begin{fact}
  The following are equivalent for every $\Aa\subseteq\U$
  \begin{itemize}
    \item[1.] $\Aa$ is approximable from below;
    \item[2.] for every finite set $A\subseteq\Aa$ there is a $b\in\V$ such that $A\subseteq\phi(\U\,;b)\subseteq\Aa$.\QED
  \end{itemize}
\end{fact}

Towards the main theorem of this section we prove three separated lemmas.

\begin{lemma}
  Let $\phi(x\,;z)$ be a stable formula.
  Every set $\Aa\subseteq\U$ approximable by $\phi(x\,;z)$ is approximable from below by the formula

  \ceq{\hfill \psi(x\,;z_0,\dots,z_n)}{=}{\bigwedge_{i=0}^n\phi(x\,;z_i)}
  
  where $n+1$ is the ladder index of $\phi(x\,;z)$.
\end{lemma}

\begin{proof}
  Let $A\subseteq\Aa$ be finite.
  We prove that $A\subseteq\psi(\U\,;b_0,\dots,b_n)\subseteq\Aa$ for some $b_0,\dots,b_n$.
  To obtain the $b_k$, we construct a ladder inductively.
  Pick any $b_0$ be such that $A\subseteq\phi(\U\,;b_0)$, which we can do by approximability.
  Now, suppose that $a_1,\dots,a_k$ and $b_0,\dots,b_k$ have been defined.
  If 

  \ceq{\hfill A}{\subseteq}{\bigcap_{i=0}^k\phi(\U\,;b_i)\medrel{\subseteq}\Aa}

  we set $b_{k+1}=\dots=b_n=b_k$ and stop as we already have the required parameters.
  Otherwise pick any element

  \ceq{\hfill a_{k+1}}{\in}{\bigcap_{i=0}^k\phi(\U\,;b_i)\sm\Aa}

  and some $b_{k+1}$ such that

  \ceq{\hfill A}{\subseteq}{\phi(\U\,;b_{k+1})\medrel{\subseteq}\U\sm\{a_1,\dots,a_{k+1}\}}.

  Such a parameter $b_{k+1}$ exists because $\Aa$ is approximable (apply Definition~\ref{def_approx} with $A\cup\{a_1,\dots,a_{k+1}\}$ for $A$).
  Note that at stage $n$ we have constructed a ladder of length $n$ for $\neg\phi(x\,;z)$.
  In fact for all $h\in(n]$ and $k\in[n]$ we have
  
  \ceq{\hfill\neg\phi(a_h\,;b_k)}
  {\IFF}
  {h\le k.}
  
  As $\phi(x\,;z)$ has ladder index $n+1$, by Fact~\ref{fact_stability_neg} it is not possible to further prolong this chain, hence

  \ceq{\hfill A}{\subseteq}{\bigcap_{i=0}^n\phi(\U\,;b_i)\medrel{\subseteq}\Aa}

  as required.
\end{proof}

We prove that the formula $\psi(x\,;z_0,\dots,z_n)$ in the lemma above is itself stable, though with a larger ladder index.
  
\begin{lemma}
  Let $\psi_i(x\,;z)$, where $i=1,\dots,m$, be formulas with ladder index $n_i$. Let
  
  \ceq{\hfill \phi(x\,;z)}{=}{\bigwedge_{i=1}^m\phi_i(x\,;z)}
  
  Then $\phi(x\,;z)$ has ladder index $< R(n_1+1,\dots, n_m+1)$, the Ramsey number for $m$-colorings.
\end{lemma}
  
\begin{proof} 
  Suppose for a contradiction that there is a ladder $a_1,\dots,a_n$ and $b_0,\dots,b_n$, where $n=R(n_1+1,\dots, n_m+1)-1$.
  Let $C_i$ contains the pairs $\{h,k\}$ such that $\neg\phi_i(a_h\,;b_k)$ and $0\le k<h\le n$.
  Then from \ssf{ld} we obtain 
  
  \ceq{\hfill\bigcup_{i=1}^mC_i}{=}{\binom{[n]}{2}}
  
  By the definition of $n$, for some $i\in[m]$, there is a set $H$ of cardinality $n_i+1$ such that $H^{(2)}\subseteq C_i$.
  Assume $i{=}1$ for definiteness.

  Write $a'_1,\dots,a'_{n_1}$ and $b'_0,\dots,b'_{n_1}$ for the tuples obtained by restricting $a_1,\dots,a_n$ and $b_0,\dots,b_n$ to the indexes in $H$.
  These tuples witness that $\phi_1(x\,;z)$ has ladder index at least $n_1+1$, which contradicts the assumption of the lemma.
\end{proof}

To apply the proposition to the formula $\psi(x\,;z_0,\dots,z_n)$ in the lemma above, let $z=z_0,\dots,z_n$ and let $\phi_i(x\,;z)=\phi(x\,;z_i)$.
That is, $\phi_i(x\,;z)$ defines a relation between $\U$ and $\V^{n+1}$ that depends only on the $i$-th coordinate.
The ladder index of every $\phi_i(x\,;z)$ is the same as $\phi(x\,;z_0)$ as a relation between $\U$ and $\V$.


\begin{lemma}
  If $\Aa$ is approximated from below by a stable formula $\phi(x\,;z)$ then for some $b_0,\dots,b_n\in\V$ 
  \\[-1ex]
  \ceq{\hfill \Aa}{=}{\bigcup^n_{i=0}\phi(\U\,;b_i)}
  
  where $n+1$ is the ladder index of $\phi(x\,;z)$. 
\end{lemma}
  
\begin{proof}
  Let $A\subseteq\U$ be finite.
  To obtain the $b_k$, we construct a ladder by stages.
  Pick any $b_0$ be such that $\phi(\U\,;b_0)\subseteq\Aa$.
  Now, suppose that $a_1,\dots,a_k$ and $b_0,\dots,b_k$ have been defined.
  If 
  \\[-1ex]
  \ceq{\hfill\Aa}{\subseteq}{\bigcup_{i=1}^k\phi(\U\,;b_i)}

  we set $b_{k+1}=\dots=b_n=b_k$ and stop.
  As the construction guarantees the converse inclusion, we have the required parameters.
  Otherwise pick any element

  \ceq{\hfill a_{k+1}}{\in}{\Aa\sm\bigcup_{i=1}^k\phi(\U\,;b_i)}

  and some $b_{k+1}$ such that

  \ceq{\hfill \{a_1,\dots,a_{k+1}\}}{\subseteq}{\phi(\U\,;b_{k+1})\medrel{\subseteq}\Aa}.

  Such a parameter $b_{k+1}$ exists because $\Aa$ is approximable from below.
  Note that at stage $n$ we have constructed a ladder of length $n$ for $\phi(x\,;z)$.
  In fact for all $h\in(n]$ and $k\in[n]$ we have
  
  \ceq{\hfill\neg\phi(a_h\,;b_k)}
  {\IFF}
  {h\le k.}
  
  As $\phi(x\,;z)$ has ladder index $n+1$, it is not possible to prolonge this chain, hence

  \ceq{\hfill\Aa}{=}{\bigcup_{i=0}^n\phi(\U\,;b_i)}

  as required.
\end{proof}
  
The main theorem of this section is an immediate corollary of the three lemmas above.

\begin{theorem}\label{thm_stable_definability}
  Let $\phi(x\,;z)$ be stable.
  Then there are $m, n$ such every set $\Aa\subseteq\U$ approximable by $\phi(x\,;z)$ is definable by $\psi(x\,;\bar b)$, where

  \ceq{\hfill\psi(x\,;\bar z)}{=}{\bigvee_{j=0}^m\bigwedge_{i=0}^n\phi(x\,;z_{i,j})}
  
  and $\bar b\in\V^{n\times m}$ is some $n{\times}m$-tuple of parameters.\QED
\end{theorem}

Note that the numbers $m,n$ in the theorem above do not depend on the set $\Aa$ approximated by $\phi(x\,;z)$. As a matter of fact, $m,n$ only depend on the ladder index of $\phi(x\,;z)$.

We conclude this section with the sketch of an argument that shows that stable formulas have finite 2-rank, that is, \ssf{1}$\IMP$\ssf{2} in Theorem~\ref{thm_hodges}.

As a matter of fact, below we prove an apparently weaker claim
\begin{itemize}
  \item[\#] if there is a branching tree of height $\omega$, say $\{a_s:s\in2^{<\omega}\}$, the ladder index is infinite.
\end{itemize}
In general, infinite 2-rank does not implies the existence of a branching tree of height $\omega$.
Nevertheless, by standard model theoretic argument of compactness, \# suffices to obtain \ssf{1}$\IMP$\ssf{2} in Theorem~\ref{thm_hodges}.
Model theory is beyond the scope of this notes, hence here we only present the argument that proves \#.

First note that Theorem~\ref{thm_stable_definability} remains true when $\U$ is replaced by a subset $\U'\subseteq\U$.
It is also clear that the formula $\psi(x\,;\bar z)$ that proves the theorem for $\U$, works also for any $\U'\subseteq\U$ (in fact, the ladder index does not decrease when moving to a subset).

For $s\in2^\omega$, let $\U_s=\{a_{s\restriction n}:n<\omega\}\subseteq\U$.
Let $\Aa_s=\{a_{s\restriction n}:n<\omega,\ s_n=1\}$.
Then $\Aa_s\subseteq\U_s$ is approximable with respect to the collection $\phi(\U_s\,;b)_{b\in\V}$.
Therefore, from the theorem above, we obtain $\Aa_s=\psi(\U_s\,;\bar b_s)$ for some  $\bar b_s\in\V^{n\times m}$, where the formula $\psi(x\,;\bar z)$ does non depend on $s$.

For $s\neq s'$, let $n$ be least such that $s_n\neq s'_n$.
Then $a_{s\restriction n}=a_{s'\restriction n}$ belongs to $\U_s\cap\U_{s'}$ and to $\Aa_s\simdiff\Aa_{s'}$.
Therefore $\bar b_s\neq\bar b_{s'}$, hence there is a continuum of such tuples $\bar b_s$.
On the other hand, without loss of generality we can assume that $\V$ is a countable set. 
A contradiction. 

% Assume the 2-rank is infinite and reason for a contradiction.
% Assume for the moment that the rank is $\omega$, in the sense that there is an infinite branching tree $\<a_r:r\in2^{<\omega}\>$. 
% Let $\<b_s:s\in2^{\omega}\>$ be witnesses of \ssf{2r}.
% Let $Q\subseteq\{b_s:s\in2^{\omega}\}$ the set of sequences that are eventually $0$.
% Note that in the proof of Theorem~\ref{thm_stable_definability} we can require that $\bar b\in Q^{n\times m}$.
% But there are 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\section{Stable Erd\H{o}s-Hajnal}

\end{document}
